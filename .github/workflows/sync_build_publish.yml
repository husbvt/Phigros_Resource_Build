name: Sync â†’ Build â†’ Publish Phigros Resources

on:
  workflow_dispatch:
  schedule:
    - cron: "0 * * * *"   # æ¯å°æ—¶è‡ªåŠ¨æ£€æŸ¥ä¸Šæ¸¸æ›´æ–°
  push:
    branches: [ main ]   # æœ¬ä»“åº“æ›´æ–°ä¹Ÿä¼šè§¦å‘

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # ========== 1ï¸âƒ£ åŒæ­¥ä¸Šæ¸¸ Phigros-history ==========
      - name: Checkout Phigros-history
        uses: actions/checkout@v4
        with:
          repository: SteveZMTstudios/Phigros-history
          path: history

      # ========== 2ï¸âƒ£ å®‰è£… 7z ==========
      - name: Install p7zip
        run: sudo apt-get update && sudo apt-get install -y p7zip-full

      # ========== 3ï¸âƒ£ è§£å‹ 7z åˆ†å· ==========
      - name: Extract 7z archives
        run: |
          cd history
          shopt -s nullglob
          for f in *.7z; do
            echo "Extracting $f"
            7z x "$f"
          done

      # ========== 4ï¸âƒ£ æŸ¥æ‰¾å¹¶å¤åˆ¶ APK ==========
      - name: Prepare Phigros.apk
        run: |
          cd history
          APK=$(find . -name "*.apk" | head -n 1)
          if [ -z "$APK" ]; then
            echo "âŒ APK not found"
            exit 1
          fi
          echo "Found APK: $APK"
          cp "$APK" Phigros.apk

      # ========== 5ï¸âƒ£ Checkout ä¸»èµ„æºä»“åº“ ==========
      - name: Checkout Phigros_Resource1
        uses: actions/checkout@v4
        with:
          path: resource

      # ========== 6ï¸âƒ£ åŒæ­¥ APK åˆ°èµ„æºä»“åº“ ==========
      - name: Update APK
        run: |
          cp history/Phigros.apk resource/Phigros.apk

      # ========== 7ï¸âƒ£ Python ç¯å¢ƒ ==========
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      # ========== 8ï¸âƒ£ å®‰è£…ä¾èµ–ï¼ˆå¦‚å­˜åœ¨ï¼‰ ==========
      - name: Install Python dependencies
        working-directory: resource
        run: |
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi

      # ========== 9ï¸âƒ£ æ¸…ç†æ—§æ„å»ºç»“æœ ==========
      - name: Clean old outputs
        working-directory: resource
        run: |
          rm -rf avatar chart illustration illustrationBlur illustrationLowRes music

      # ========== ğŸ”Ÿ è¿è¡Œ resources.py ==========
      - name: Run resources.py
        working-directory: resource
        run: python resources.py

      # ========== 1ï¸âƒ£1ï¸âƒ£ Checkout æ„å»ºåˆ†ä»“åº“ ==========
      - name: Checkout build repo
        uses: actions/checkout@v4
        with:
          repository: ${{ secrets.BUILD_REPO }}
          token: ${{ secrets.BUILD_PAT }}
          path: build

      # ========== 1ï¸âƒ£2ï¸âƒ£ åŒæ­¥æ„å»ºäº§ç‰© ==========
      - name: Publish resources
        run: |
          rsync -av --delete \
            resource/avatar \
            resource/chart \
            resource/illustration \
            resource/illustrationBlur \
            resource/illustrationLowRes \
            resource/music \
            build/

      # ========== 1ï¸âƒ£3ï¸âƒ£ æäº¤å¹¶æ¨é€ ==========
      - name: Commit & Push build repo
        working-directory: build
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions@users.noreply.github.com"
          git add .
          if git diff --cached --quiet; then
            echo "âœ… No changes to publish"
          else
            git commit -m "Auto build $(date -u '+%Y-%m-%d %H:%M UTC')"
            git push origin ${{ secrets.BUILD_BRANCH }}
          fi
